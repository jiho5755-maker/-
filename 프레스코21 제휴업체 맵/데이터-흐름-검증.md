# 데이터 흐름 검증 및 계획 확인

## 📋 초기 계획 요약

### 1. Google Apps Script (백엔드)
- **onEdit 함수**: N열(심사상태)이 '승인'으로 변경되면 F열(도로명 주소)를 Geocoding하여 O열(위도), P열(경도) 자동 입력
- **doGet 함수**: N열이 '승인'이고 위도/경도가 있는 데이터만 JSON으로 반환

### 2. HTML/JS (프론트엔드)
- Google Apps Script의 JSON API를 fetch
- 네이버 지도에 마커 표시
- InfoWindow에 업체 정보 표시

---

## ✅ 현재 구현 상태 확인

### Google Apps Script 데이터 구조

**스프레드시트 열 구조:**
- A열: 타임스탬프 (사용 안 함)
- B열: 업체명 → `partner.name`
- C열: 카테고리 → `partner.category`
- D열: 대표자성함 (제외)
- E열: 사업자등록번호 (제외)
- F열: 도로명 주소 → `partner.address`
- G열: 상세 주소 → `partner.detailAddress`
- H열: 대표 전화번호 → `partner.phone`
- I열: 담당자 이메일 (제외)
- J열: 운영 시간 → `partner.hours`
- K열: 홈페이지/블로그/인스타 링크 → `partner.link`
- L열: 업체 한 줄 소개 → `partner.description`
- M열: 업체 대표 이미지 URL → `partner.imageUrl`
- N열: 심사상태 (제외, '승인'일 때만 필터링)
- O열: 위도 → `partner.lat`
- P열: 경도 → `partner.lng`

**doGet 함수 반환 구조:**
```javascript
{
  success: true,
  partners: [
    {
      name: "업체명",           // B열
      category: "카테고리",      // C열
      address: "도로명 주소",    // F열
      detailAddress: "상세 주소", // G열
      phone: "전화번호",         // H열
      hours: "운영시간",         // J열
      link: "링크",             // K열
      description: "소개",       // L열
      imageUrl: "이미지URL",     // M열
      lat: 37.5015,            // O열
      lng: 127.1222            // P열
    }
  ],
  count: 1,
  timestamp: "2024-01-03T..."
}
```

### HTML/JS 데이터 사용

**fetch 호출:**
```javascript
fetch(GOOGLE_SHEET_API_URL)
  .then(response => response.json())
  .then(data => {
    // data.partners 배열 사용
    partnersData = data.partners;
    createMarkers(); // 네이버 지도에 마커 생성
  })
```

**마커 생성:**
```javascript
partnersData.forEach(function(partner) {
  // partner.lat, partner.lng 사용
  // partner.name, partner.category 등 사용
})
```

**InfoWindow 생성:**
```javascript
createInfoWindowHTML(partner) {
  // partner.imageUrl → 이미지
  // partner.name → 업체명
  // partner.category → 카테고리
  // partner.description → 소개
  // partner.address, partner.detailAddress → 주소
  // partner.hours → 운영시간
  // partner.phone → 전화번호
  // partner.link → 링크
}
```

---

## ✅ 검증 결과

### 데이터 구조 일치성: ✅ 정상
- Google Apps Script가 반환하는 필드명과 HTML에서 사용하는 필드명이 일치합니다
- `partners` 배열 구조도 올바릅니다

### 필수 데이터 포함: ✅ 정상
- ✅ 업체명 (B열 → name)
- ✅ 카테고리 (C열 → category)
- ✅ 도로명 주소 (F열 → address)
- ✅ 상세 주소 (G열 → detailAddress)
- ✅ 전화번호 (H열 → phone)
- ✅ 운영시간 (J열 → hours)
- ✅ 링크 (K열 → link)
- ✅ 소개 (L열 → description)
- ✅ 이미지URL (M열 → imageUrl)
- ✅ 위도 (O열 → lat)
- ✅ 경도 (P열 → lng)

### 제외된 데이터: ✅ 정상
- ✅ 대표자성함 (D열) - 제외됨
- ✅ 사업자등록번호 (E열) - 제외됨
- ✅ 이메일 (I열) - 제외됨
- ✅ 심사상태 (N열) - 제외됨 (필터링용으로만 사용)

---

## 🔍 문제 진단

### 사용자가 말한 "이전에 실패한 데이터 파일"

가능한 원인:

1. **브라우저 캐시 문제** (가능성 높음)
   - 브라우저가 이전 HTML 파일을 캐시에 저장
   - 해결: 강제 새로고침 (Cmd+Shift+R 또는 Ctrl+Shift+R)

2. **서버가 다른 폴더에서 실행됨**
   - 다른 폴더의 HTML 파일이 로드됨
   - 해결: 올바른 폴더에서 서버 실행 확인

3. **파일 이름 혼동**
   - 다른 HTML 파일이 열림
   - 해결: 파일 이름과 경로 확인

4. **Google Apps Script 배포 URL 문제**
   - 이전 배포 URL이 사용됨
   - 해결: 최신 배포 URL 확인

---

## ✅ 해결 방법

### 1. 파일 경로 확인
```bash
cd "/Users/jangjiho/Desktop/커서AI/프레스코21 제휴업체 맵"
ls -la *.html
```

### 2. 브라우저 캐시 완전 삭제
- 개발자 도구(F12) 열기
- Network 탭 > "Disable cache" 체크
- Cmd+Shift+R (Mac) 또는 Ctrl+Shift+R (Windows)

### 3. 서버 재시작
```bash
# 기존 서버 종료 (Ctrl+C)
# 새로 시작
cd "/Users/jangjiho/Desktop/커서AI/프레스코21 제휴업체 맵"
python3 -m http.server 8080
```

### 4. 올바른 URL로 접근
```
http://localhost:8080/제휴업체-지도-통합본.html
```

### 5. Google Apps Script 배포 URL 확인
- HTML 파일 362번째 줄의 URL이 최신 배포 URL인지 확인
- Apps Script에서 배포 > 배포 관리 > 최신 URL 확인

---

## 📊 데이터 흐름도

```
[구글 스프레드시트]
    ↓
[N열: '승인' 입력]
    ↓
[onEdit 함수 자동 실행]
    ↓
[F열 주소 → Geocoding → O/P열에 위도/경도 입력]
    ↓
[HTML에서 fetch(GOOGLE_SHEET_API_URL)]
    ↓
[doGet 함수 실행]
    ↓
[N열='승인' + 위도/경도 있는 행만 필터링]
    ↓
[JSON 반환: {success: true, partners: [...]}]
    ↓
[HTML: partnersData = data.partners]
    ↓
[네이버 지도에 마커 생성]
    ↓
[마커 클릭 → InfoWindow 표시]
```

---

## ✅ 최종 확인 사항

- [ ] Google Apps Script 코드가 최신 배포에 반영됨
- [ ] HTML 파일의 API URL이 최신 배포 URL과 일치
- [ ] 브라우저 캐시가 삭제됨
- [ ] 로컬 서버가 올바른 폴더에서 실행됨
- [ ] 올바른 URL로 접근 (`http://localhost:8080/제휴업체-지도-통합본.html`)
- [ ] 구글 시트에 N열='승인', O/P열에 위도/경도 값이 있는 데이터 존재

---

## 🎯 결론

**데이터 구조와 코드는 올바르게 구현되어 있습니다!**

문제는 데이터 구조가 아니라:
1. 브라우저 캐시
2. 서버 실행 위치
3. URL 접근 방법

중 하나일 가능성이 높습니다.

위의 해결 방법을 순서대로 시도해보세요.

