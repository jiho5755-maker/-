<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 SMB ERP - ì œì¡°/ìœ í†µ ì „ìš© HR Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap');
        
        :root {
            --primary: #2563eb;
            --danger: #dc2626;
            --warning: #f59e0b;
            --success: #10b981;
            --bg-sidebar: #1e293b;
        }

        body { 
            font-family: 'Noto Sans KR', sans-serif; 
            background-color: #f8fafc; 
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Alert Animation */
        @keyframes pulse-red {
            0%, 100% { background-color: #fee2e2; border-color: #dc2626; }
            50% { background-color: #fecaca; border-color: #ef4444; }
        }
        .alert-pulse { animation: pulse-red 1.5s ease-in-out infinite; }

        /* Badge */
        .badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #dc2626;
            color: white;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 11px;
            font-weight: bold;
        }

        /* Print Styles */
        @media print {
            body * { visibility: hidden; }
            .print-area, .print-area * { visibility: visible; }
            .print-area { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
            @page { size: A4; margin: 15mm; }
        }

        /* Mobile Touch Friendly */
        .touch-btn {
            min-height: 48px;
            font-size: 16px;
            font-weight: 600;
        }

        /* Fade Animation */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Status Indicators */
        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }
        .status-active { background: #10b981; }
        .status-vacation { background: #f59e0b; }
        .status-absent { background: #dc2626; }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-64 bg-slate-800 text-white flex flex-col no-print shadow-2xl z-20">
        <div class="p-6 border-b border-slate-700">
            <h1 class="text-2xl font-bold text-blue-400">
                <i class="fa-solid fa-industry"></i> SMB ERP
            </h1>
            <p class="text-xs text-slate-400 mt-1">ì œì¡°/ìœ í†µ ì „ìš© V11 Final</p>
        </div>
        <nav class="flex-1 overflow-y-auto py-4">
            <ul class="space-y-1 px-3">
                <li class="relative">
                    <button onclick="renderTab('dashboard')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-700 transition flex items-center gap-3">
                        <i class="fa-solid fa-chart-line w-5"></i> 
                        <span>ëŒ€ì‹œë³´ë“œ</span>
                        <span id="badge-dashboard" class="badge hidden">0</span>
                    </button>
                </li>
                <li>
                    <button onclick="renderTab('people')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-700 transition flex items-center gap-3">
                        <i class="fa-solid fa-users w-5"></i> ì§ì› & ë¦¬ìŠ¤í¬
                    </button>
                </li>
                <li>
                    <button onclick="renderTab('time')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-700 transition flex items-center gap-3">
                        <i class="fa-regular fa-clock w-5"></i> ê·¼íƒœ & ì•ˆì „
                    </button>
                </li>
                <li class="relative">
                    <button onclick="renderTab('payroll')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-700 transition flex items-center gap-3">
                        <i class="fa-solid fa-money-bill-wave w-5"></i> ê¸‰ì—¬ & ì§€ì›ê¸ˆ
                    </button>
                </li>
                <li class="relative">
                    <button onclick="renderTab('admin')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-700 transition flex items-center gap-3">
                        <i class="fa-solid fa-box w-5"></i> 
                        <span>ì†Œëª¨í’ˆ & ë¬¸ì„œ</span>
                        <span id="badge-admin" class="badge hidden">0</span>
                    </button>
                </li>
                <li>
                    <button onclick="renderTab('settings')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-700 transition flex items-center gap-3">
                        <i class="fa-solid fa-gear w-5"></i> ì„¤ì •
                    </button>
                </li>
            </ul>
        </nav>
        <div class="p-4 border-t border-slate-700 text-center text-xs text-slate-500">
            <div class="mb-2">
                <i class="fa-solid fa-database"></i> 
                LocalStorage ì €ì¥
            </div>
            <button onclick="backupData()" class="w-full bg-slate-700 hover:bg-slate-600 px-3 py-2 rounded text-xs transition">
                <i class="fa-solid fa-download"></i> ë°±ì—…
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-screen overflow-hidden bg-gray-50">
        <header class="bg-white shadow-sm px-6 md:px-8 py-4 flex justify-between items-center no-print z-10">
            <h2 id="page-title" class="text-lg md:text-xl font-bold text-slate-800">ëŒ€ì‹œë³´ë“œ</h2>
            <div class="flex items-center gap-3">
                <span id="current-date" class="text-xs md:text-sm text-slate-500 font-medium"></span>
                <button onclick="restoreData()" class="bg-green-50 text-green-600 px-3 py-1.5 rounded text-xs md:text-sm hover:bg-green-100 transition">
                    <i class="fa-solid fa-upload"></i> ë³µêµ¬
                </button>
            </div>
        </header>

        <div id="content-area" class="flex-1 overflow-y-auto p-4 md:p-8 fade-in">
            <!-- Dynamic Content -->
        </div>
    </main>

    <script>
        // ==========================================
        // 1. Database & Initial Setup
        // ==========================================
        const DB_KEY = 'SMB_ERP_V11_FINAL';
        const MIN_WAGE_2026 = 10320; // ì‹œê¸‰
        const MIN_WAGE_MONTHLY = MIN_WAGE_2026 * 209; // ì›”ê¸‰ ê¸°ì¤€

        let db = JSON.parse(localStorage.getItem(DB_KEY)) || {
            company: {
                name: "ì£¼ì‹íšŒì‚¬ ì˜ˆì‹œ",
                ceo: "í™ê¸¸ë™",
                address: "ê²½ê¸°ë„ ì‹œí¥ì‹œ ì‚°ë‹¨ë¡œ 123",
                bizNo: "123-45-67890",
                tel: "031-1234-5678",
                seal: "" // Base64 image
            },
            settings: {
                minWage: MIN_WAGE_2026,
                insuranceRates: {
                    pension: 4.5,
                    health: 3.545,
                    care: 12.95,
                    employment: 0.9
                },
                weeklyHours: 40,
                paidHoliday: true
            },
            employees: [],
            attendance: [], // {id, empId, date, checkIn, checkOut, safetyChecks: []}
            leaves: [], // {id, empId, type, startDate, endDate, days, status}
            incidents: [], // {id, empId, type, date, memo} - Three Strikes
            supplies: [], // {id, empId, item, qty, status, date}
            tasks: [],
            wiki: [
                {id: 1, title: "ì·¨ì—…ê·œì¹™", content: "ì§€ê° 3íšŒ = ê²½ê³  1íšŒ"},
                {id: 2, title: "Wi-Fi ë¹„ë°€ë²ˆí˜¸", content: "company2026!"},
                {id: 3, title: "ê³µíœ´ì¼ íœ´ë¬´ ê·œì •", content: "ê³µíœ´ì¼ ê·¼ë¬´ ì‹œ 1.5ë°° ìˆ˜ë‹¹"}
            ],
            lastTaskCheck: null // For recurring tasks
        };

        function saveDB() {
            localStorage.setItem(DB_KEY, JSON.stringify(db));
            updateBadges();
        }

        // ==========================================
        // 2. Helper Functions
        // ==========================================
        
        const formatCurrency = (num) => new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW' }).format(num);
        const formatDate = (date) => new Date(date).toLocaleDateString('ko-KR');
        
        function getAge(birthDate) {
            return new Date().getFullYear() - new Date(birthDate).getFullYear();
        }

        function getDaysUntil(dateStr) {
            const diff = new Date(dateStr) - new Date();
            return Math.ceil(diff / (1000 * 60 * 60 * 24));
        }

        function updateBadges() {
            // Dashboard badge
            const pendingLeaves = db.leaves.filter(l => l.status === 'pending').length;
            const pendingSupplies = db.supplies.filter(s => s.status === 'pending').length;
            const totalAlerts = pendingLeaves + pendingSupplies;
            
            const dashBadge = document.getElementById('badge-dashboard');
            if (dashBadge) {
                if (totalAlerts > 0) {
                    dashBadge.textContent = totalAlerts;
                    dashBadge.classList.remove('hidden');
                } else {
                    dashBadge.classList.add('hidden');
                }
            }

            // Admin badge
            const adminBadge = document.getElementById('badge-admin');
            if (adminBadge) {
                if (pendingSupplies > 0) {
                    adminBadge.textContent = pendingSupplies;
                    adminBadge.classList.remove('hidden');
                } else {
                    adminBadge.classList.add('hidden');
                }
            }
        }

        // ==========================================
        // 3. Grant Sniper Logic (ì •ë¶€ì§€ì›ê¸ˆ ë§¤ì¹­)
        // ==========================================
        
        function analyzeGrants(emp) {
            const grants = [];
            const age = getAge(emp.birthDate);
            const workMonths = Math.floor((new Date() - new Date(emp.joinDate)) / (1000 * 60 * 60 * 24 * 30));

            // 1. ì²­ë…„ì¼ìë¦¬ë„ì•½ì¥ë ¤ê¸ˆ
            if (age >= 15 && age <= 34 && emp.salary >= 2000000) {
                grants.push({
                    name: "ì²­ë…„ì¼ìë¦¬ë„ì•½ì¥ë ¤ê¸ˆ",
                    amount: "ì›” 60ë§Œì› (ìµœëŒ€ 12ê°œì›”)",
                    deadline: "ì…ì‚¬ í›„ 3ê°œì›” ì´ë‚´",
                    docs: ["ê·¼ë¡œê³„ì•½ì„œ", "ì„ê¸ˆëŒ€ì¥", "ì¶œí‡´ê·¼ê¸°ë¡"]
                });
            }

            // 2. ê³ ë ¹ì ê³ ìš©ì§€ì›ê¸ˆ
            if (age >= 60) {
                grants.push({
                    name: "ê³ ë ¹ì ê³ ìš©ì§€ì›ê¸ˆ",
                    amount: "ë¶„ê¸° 30ë§Œì›",
                    deadline: "ë¶„ê¸°ë³„ ì‹ ì²­",
                    docs: ["ê·¼ë¡œê³„ì•½ì„œ", "ì£¼ë¯¼ë“±ë¡ë“±ë³¸"]
                });
            }

            // 3. ë‘ë£¨ëˆ„ë¦¬ ì‚¬íšŒë³´í—˜ë£Œ
            if (emp.salary < 2700000 && emp.type === 'ì •ê·œì§') {
                grants.push({
                    name: "ë‘ë£¨ëˆ„ë¦¬ ì‚¬íšŒë³´í—˜ë£Œ ì§€ì›",
                    amount: "4ëŒ€ë³´í—˜ë£Œ 80% ì§€ì›",
                    deadline: "ì—°ì¤‘ ì‹ ì²­ ê°€ëŠ¥",
                    docs: ["ì‚¬ì—…ìë“±ë¡ì¦", "ê·¼ë¡œê³„ì•½ì„œ"]
                });
            }

            // 4. ìœ¡ì•„íœ´ì§ ëŒ€ì²´ì¸ë ¥ ì§€ì›ê¸ˆ
            if (emp.hasChild && workMonths >= 6) {
                grants.push({
                    name: "ìœ¡ì•„íœ´ì§ ëŒ€ì²´ì¸ë ¥ ì§€ì›ê¸ˆ",
                    amount: "ì›” 120ë§Œì› (ëŒ€ì²´ì¸ë ¥ ì±„ìš© ì‹œ)",
                    deadline: "íœ´ì§ ì‹œì‘ ì „",
                    docs: ["ìœ¡ì•„íœ´ì§ ì‹ ì²­ì„œ", "ê°€ì¡±ê´€ê³„ì¦ëª…ì„œ"]
                });
            }

            // 5. ì¼ìë¦¬ì•ˆì •ìê¸ˆ
            if (emp.salary >= MIN_WAGE_MONTHLY && emp.salary < 2700000) {
                grants.push({
                    name: "ì¼ìë¦¬ì•ˆì •ìê¸ˆ",
                    amount: "ì›” 4ë§Œì›",
                    deadline: "ë¶„ê¸°ë³„ ì‹ ì²­",
                    docs: ["ì„ê¸ˆëŒ€ì¥"]
                });
            }

            return grants;
        }

        // ==========================================
        // 4. Payroll Calculation Engine
        // ==========================================
        
        function calculatePayroll(empId, year, month) {
            const emp = db.employees.find(e => e.id == empId);
            if (!emp) return null;

            const monthStr = `${year}-${String(month).padStart(2,'0')}`;
            const records = db.attendance.filter(a => a.empId == empId && a.date.startsWith(monthStr));

            let totalWorkHours = 0;
            let overtimeHours = 0;
            let nightHours = 0;
            let holidayHours = 0;
            
            records.forEach(r => {
                if(r.checkIn && r.checkOut) {
                    const start = new Date(`2000-01-01 ${r.checkIn}`);
                    const end = new Date(`2000-01-01 ${r.checkOut}`);
                    let hours = (end - start) / (1000 * 60 * 60);
                    if (hours < 0) hours += 24;
                    
                    // Break deduction (4ì‹œê°„ ì´ìƒ ê·¼ë¬´ ì‹œ 30ë¶„ íœ´ê²Œ)
                    if (hours >= 4) hours -= 0.5;
                    
                    totalWorkHours += hours;
                    
                    // Overtime (8ì‹œê°„ ì´ˆê³¼)
                    if (hours > 8) overtimeHours += (hours - 8);
                    
                    // Night shift (22:00-06:00)
                    const checkInHour = parseInt(r.checkIn.split(':')[0]);
                    const checkOutHour = parseInt(r.checkOut.split(':')[0]);
                    if (checkInHour >= 22 || checkInHour < 6 || checkOutHour >= 22 || checkOutHour < 6) {
                        nightHours += Math.min(hours, 2); // Simplified
                    }
                }
            });

            // í”„ë¦¬ëœì„œëŠ” 3.3% ì›ì²œì§•ìˆ˜ë§Œ
            if (emp.type === 'í”„ë¦¬ëœì„œ') {
                const freelanceFee = emp.salary;
                const withholdingTax = Math.floor(freelanceFee * 0.033);
                return {
                    basePay: freelanceFee,
                    otPay: 0,
                    totalPay: freelanceFee,
                    tax: { withholdingTax },
                    totalDeduction: withholdingTax,
                    netPay: freelanceFee - withholdingTax,
                    days: records.length,
                    otHours: 0,
                    isFreelancer: true
                };
            }

            // ì •ê·œì§/ê³„ì•½ì§ ê³„ì‚°
            const hourlyRate = emp.salary / 209;
            const basePay = emp.salary;
            const otPay = Math.floor(overtimeHours * hourlyRate * 1.5);
            const nightPay = Math.floor(nightHours * hourlyRate * 0.5);
            const totalPay = basePay + otPay + nightPay;

            // 4ëŒ€ë³´í—˜
            const tax = {
                pension: Math.floor(totalPay * (db.settings.insuranceRates.pension / 100)),
                health: Math.floor(totalPay * (db.settings.insuranceRates.health / 100)),
                employment: Math.floor(totalPay * (db.settings.insuranceRates.employment / 100)),
                income: Math.floor(totalPay * 0.03) // ê°„ì´ì„¸ì•¡
            };
            tax.care = Math.floor(tax.health * (db.settings.insuranceRates.care / 100));
            const totalDeduction = tax.pension + tax.health + tax.care + tax.employment + tax.income;

            return {
                basePay, otPay, nightPay, totalPay, tax, totalDeduction,
                netPay: totalPay - totalDeduction,
                days: records.length,
                otHours: overtimeHours.toFixed(1),
                isFreelancer: false
            };
        }

        // Anomaly Detection
        function detectPayrollAnomaly(empId, currentPay) {
            // Check minimum wage
            if (currentPay < MIN_WAGE_MONTHLY) {
                return { type: 'danger', msg: `âš ï¸ ìµœì €ì„ê¸ˆ ë¯¸ë‹¬! (ê¸°ì¤€: ${formatCurrency(MIN_WAGE_MONTHLY)})` };
            }
            
            // TODO: Check vs last month (requires history)
            return null;
        }

        // ==========================================
        // 5. Recurring Tasks Auto-Generation
        // ==========================================
        
        function checkRecurringTasks() {
            const today = new Date();
            const day = today.getDate();
            const lastCheck = db.lastTaskCheck ? new Date(db.lastTaskCheck) : null;

            // ê°™ì€ ë‚ ì´ë©´ ìŠ¤í‚µ
            if (lastCheck && lastCheck.toDateString() === today.toDateString()) return;

            const tasksToAdd = [];

            // ë§¤ì›” 10ì¼: ì›ì²œì„¸ ì‹ ê³ 
            if (day === 10) {
                tasksToAdd.push({
                    id: Date.now() + 1,
                    title: `${today.getMonth() + 1}ì›” ì›ì²œì„¸ ì‹ ê³ `,
                    status: 'todo',
                    deadline: `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-10`,
                    recurring: true
                });
            }

            // ë§¤ì›” 25ì¼: ê¸‰ì—¬ ì´ì²´
            if (day === 25) {
                tasksToAdd.push({
                    id: Date.now() + 2,
                    title: `${today.getMonth() + 1}ì›” ê¸‰ì—¬ ì´ì²´`,
                    status: 'todo',
                    deadline: `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-25`,
                    recurring: true
                });
            }

            // ë¶„ê¸°ë§: ë¶€ê°€ì„¸ ì‹ ê³ 
            if ([3, 6, 9, 12].includes(today.getMonth() + 1) && day === 25) {
                tasksToAdd.push({
                    id: Date.now() + 3,
                    title: `${Math.ceil((today.getMonth() + 1) / 3)}ë¶„ê¸° ë¶€ê°€ì„¸ ì‹ ê³ `,
                    status: 'todo',
                    deadline: `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-25`,
                    recurring: true
                });
            }

            if (tasksToAdd.length > 0) {
                db.tasks.push(...tasksToAdd);
                db.lastTaskCheck = today.toISOString();
                saveDB();
            }
        }

        // ==========================================
        // 6. Three Strikes Rule
        // ==========================================
        
        function checkThreeStrikes(empId) {
            const incidents = db.incidents.filter(i => i.empId == empId);
            const incidentTypes = {};
            
            incidents.forEach(inc => {
                incidentTypes[inc.type] = (incidentTypes[inc.type] || 0) + 1;
            });

            const warnings = [];
            for (const [type, count] of Object.entries(incidentTypes)) {
                if (count >= 3) {
                    warnings.push({ type, count });
                }
            }

            return warnings;
        }

        // ==========================================
        // 7. Render Functions (SPA Router)
        // ==========================================

        function renderTab(tabName) {
            const content = document.getElementById('content-area');
            const title = document.getElementById('page-title');
            content.innerHTML = '';
            
            // Highlight active nav
            document.querySelectorAll('.nav-btn').forEach(b => {
                b.classList.remove('bg-slate-700', 'text-blue-400');
            });
            event?.target?.closest('.nav-btn')?.classList.add('bg-slate-700', 'text-blue-400');

            switch(tabName) {
                case 'dashboard': title.innerText = 'ëŒ€ì‹œë³´ë“œ'; renderDashboard(content); break;
                case 'people': title.innerText = 'ì§ì› ê´€ë¦¬ & ë¦¬ìŠ¤í¬'; renderPeople(content); break;
                case 'time': title.innerText = 'ê·¼íƒœ & ì•ˆì „ì ê²€'; renderTime(content); break;
                case 'payroll': title.innerText = 'ê¸‰ì—¬ & ì§€ì›ê¸ˆ'; renderPayroll(content); break;
                case 'admin': title.innerText = 'ì†Œëª¨í’ˆ & ë¬¸ì„œ'; renderAdmin(content); break;
                case 'settings': title.innerText = 'ì‹œìŠ¤í…œ ì„¤ì •'; renderSettings(content); break;
            }
        }

        // --- DASHBOARD ---
        function renderDashboard(container) {
            checkRecurringTasks();
            
            const empCount = db.employees.length;
            const todayStr = new Date().toISOString().split('T')[0];
            const presentToday = db.attendance.filter(a => a.date === todayStr && a.checkIn).length;
            const onLeaveToday = db.leaves.filter(l => 
                l.status === 'approved' && 
                new Date(l.startDate) <= new Date(todayStr) && 
                new Date(l.endDate) >= new Date(todayStr)
            ).length;

            const now = new Date();
            const expectedPayroll = db.employees.reduce((sum, emp) => {
                const calc = calculatePayroll(emp.id, now.getFullYear(), now.getMonth() + 1);
                return sum + (calc ? calc.totalPay : 0);
            }, 0);

            const pendingLeaves = db.leaves.filter(l => l.status === 'pending').length;
            const pendingSupplies = db.supplies.filter(s => s.status === 'pending').length;

            container.innerHTML = `
                <!-- Status Cards -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-slate-100">
                        <div class="text-slate-500 text-xs md:text-sm">ì´ ì§ì› ìˆ˜</div>
                        <div class="text-2xl md:text-3xl font-bold text-slate-800 mt-2">${empCount}ëª…</div>
                    </div>
                    <div class="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-slate-100">
                        <div class="text-slate-500 text-xs md:text-sm">ê¸ˆì¼ ì¶œê·¼</div>
                        <div class="text-2xl md:text-3xl font-bold text-green-600 mt-2">${presentToday}ëª…</div>
                        ${onLeaveToday > 0 ? `<div class="text-xs text-amber-500 mt-1">íœ´ê°€ ${onLeaveToday}ëª…</div>` : ''}
                    </div>
                    <div class="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-slate-100">
                        <div class="text-slate-500 text-xs md:text-sm">ì´ë²ˆ ë‹¬ ì˜ˆìƒ ê¸‰ì—¬</div>
                        <div class="text-lg md:text-2xl font-bold text-blue-600 mt-2">${formatCurrency(expectedPayroll)}</div>
                    </div>
                    <div class="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-slate-100 ${(pendingLeaves + pendingSupplies) > 0 ? 'alert-pulse' : ''}">
                        <div class="text-slate-500 text-xs md:text-sm">ìŠ¹ì¸ ëŒ€ê¸°</div>
                        <div class="text-2xl md:text-3xl font-bold text-red-600 mt-2">${pendingLeaves + pendingSupplies}ê±´</div>
                        <div class="text-xs text-slate-400 mt-1">íœ´ê°€ ${pendingLeaves} / ì†Œëª¨í’ˆ ${pendingSupplies}</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Kanban Board -->
                    <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-slate-100 p-4 md:p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-base md:text-lg">ğŸ“Œ ì—…ë¬´ ê´€ë¦¬ (Kanban)</h3>
                            <button onclick="addTaskPrompt()" class="text-xs md:text-sm bg-blue-100 text-blue-600 px-3 py-1.5 rounded hover:bg-blue-200">+ ì¶”ê°€</button>
                        </div>
                        <div class="flex gap-3 overflow-x-auto pb-4">
                            ${['todo', 'doing', 'done'].map(status => {
                                const statusNames = {todo: 'To Do', doing: 'Doing', done: 'Done'};
                                return `
                                <div class="flex-1 min-w-[180px] bg-slate-50 rounded-lg p-3">
                                    <div class="text-xs uppercase font-bold text-slate-400 mb-3">${statusNames[status]}</div>
                                    <div class="space-y-2">
                                        ${db.tasks.filter(t => t.status === status).map(t => {
                                            const daysLeft = t.deadline ? getDaysUntil(t.deadline) : null;
                                            const isUrgent = daysLeft !== null && daysLeft <= 3 && daysLeft >= 0;
                                            return `
                                            <div class="bg-white p-3 rounded shadow-sm border ${isUrgent ? 'border-red-300 bg-red-50' : 'border-slate-200'} group relative">
                                                <div class="text-xs md:text-sm font-medium pr-6">${t.title}</div>
                                                ${t.deadline ? `<div class="text-xs text-slate-400 mt-1">ë§ˆê°: ${t.deadline} ${daysLeft !== null ? `(D-${daysLeft})` : ''}</div>` : ''}
                                                <div class="absolute top-2 right-2 flex gap-1">
                                                    <button onclick="moveTask(${t.id})" class="text-xs text-blue-500 opacity-0 group-hover:opacity-100">âœ</button>
                                                    <button onclick="deleteTask(${t.id})" class="text-xs text-red-400 opacity-0 group-hover:opacity-100">Ã—</button>
                                                </div>
                                            </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <!-- Alerts & Calendar -->
                    <div class="space-y-4">
                        <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-4 md:p-6">
                            <h3 class="font-bold text-base md:text-lg mb-4">ğŸ”” ì¤‘ìš” ì•Œë¦¼</h3>
                            <ul class="space-y-3">
                                ${pendingLeaves > 0 ? `
                                <li class="flex items-start gap-3 p-3 bg-amber-50 text-amber-700 rounded-lg text-sm">
                                    <i class="fa-solid fa-user-clock mt-1"></i>
                                    <div>
                                        <span class="font-bold">íœ´ê°€ ìŠ¹ì¸ ëŒ€ê¸°</span>
                                        <p class="text-xs mt-1">${pendingLeaves}ê±´ì˜ íœ´ê°€ ì‹ ì²­ì´ ìˆìŠµë‹ˆë‹¤</p>
                                        <button onclick="renderTab('time')" class="text-xs underline mt-1">í™•ì¸í•˜ê¸°</button>
                                    </div>
                                </li>
                                ` : ''}
                                ${pendingSupplies > 0 ? `
                                <li class="flex items-start gap-3 p-3 bg-blue-50 text-blue-700 rounded-lg text-sm">
                                    <i class="fa-solid fa-box mt-1"></i>
                                    <div>
                                        <span class="font-bold">ì†Œëª¨í’ˆ ìš”ì²­</span>
                                        <p class="text-xs mt-1">${pendingSupplies}ê±´ì˜ êµ¬ë§¤ ìš”ì²­ì´ ìˆìŠµë‹ˆë‹¤</p>
                                        <button onclick="renderTab('admin')" class="text-xs underline mt-1">í™•ì¸í•˜ê¸°</button>
                                    </div>
                                </li>
                                ` : ''}
                                <li class="flex items-start gap-3 p-3 bg-red-50 text-red-700 rounded-lg text-sm">
                                    <i class="fa-solid fa-triangle-exclamation mt-1"></i>
                                    <div>
                                        <span class="font-bold">ì›ì²œì„¸ ì‹ ê³  ë§ˆê°</span>
                                        <p class="text-xs mt-1">ë§¤ì›” 10ì¼ê¹Œì§€ (D-${Math.max(0, 10 - new Date().getDate())})</p>
                                    </div>
                                </li>
                            </ul>
                        </div>

                        <!-- D-Day Counter -->
                        <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-4 md:p-6">
                            <h3 class="font-bold text-sm md:text-base mb-3">â° D-Day</h3>
                            <div class="space-y-2 text-xs md:text-sm">
                                ${db.employees.filter(e => e.contractEnd).slice(0, 3).map(e => {
                                    const dday = getDaysUntil(e.contractEnd);
                                    return `
                                    <div class="flex justify-between items-center p-2 ${dday <= 30 ? 'bg-red-50 text-red-700' : 'bg-slate-50'}  rounded">
                                        <span>${e.name} ê³„ì•½ì¢…ë£Œ</span>
                                        <span class="font-bold">D-${dday}</span>
                                    </div>
                                    `;
                                }).join('') || '<div class="text-slate-400 text-center py-4">ì„ë°•í•œ ì¼ì • ì—†ìŒ</div>'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- PEOPLE ---
        function renderPeople(container) {
            container.innerHTML = `
                <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                    <div class="p-4 md:p-6 border-b border-slate-100 flex flex-col md:flex-row justify-between items-start md:items-center gap-3">
                        <h3 class="font-bold text-base md:text-lg">ì§ì› ëª©ë¡ (${db.employees.length}ëª…)</h3>
                        <button onclick="addEmployeePrompt()" class="touch-btn w-full md:w-auto bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700">
                            <i class="fa-solid fa-user-plus"></i> ì§ì› ë“±ë¡
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-xs md:text-sm text-left">
                            <thead class="bg-slate-50 text-slate-500">
                                <tr>
                                    <th class="p-3 md:p-4">ì´ë¦„/ì§ì±…</th>
                                    <th class="p-3 md:p-4">êµ¬ë¶„</th>
                                    <th class="p-3 md:p-4">ê¸‰ì—¬</th>
                                    <th class="p-3 md:p-4">ì§€ì›ê¸ˆ ë§¤ì¹­</th>
                                    <th class="p-3 md:p-4">ê²½ê³ </th>
                                    <th class="p-3 md:p-4 text-right">ê´€ë¦¬</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100">
                                ${db.employees.map(emp => {
                                    const grants = analyzeGrants(emp);
                                    const warnings = checkThreeStrikes(emp.id);
                                    return `
                                    <tr>
                                        <td class="p-3 md:p-4">
                                            <div class="font-bold text-slate-800">${emp.name}</div>
                                            <div class="text-xs text-slate-500">${emp.position || 'ì‚¬ì›'}</div>
                                        </td>
                                        <td class="p-3 md:p-4">
                                            <span class="px-2 py-1 rounded text-xs ${
                                                emp.type === 'ì •ê·œì§' ? 'bg-green-100 text-green-700' :
                                                emp.type === 'ê³„ì•½ì§' ? 'bg-blue-100 text-blue-700' :
                                                'bg-purple-100 text-purple-700'
                                            }">${emp.type}</span>
                                        </td>
                                        <td class="p-3 md:p-4">${formatCurrency(emp.salary)}</td>
                                        <td class="p-3 md:p-4">
                                            ${grants.length > 0 
                                                ? `<button onclick="showGrantDetail(${emp.id})" class="text-xs bg-emerald-100 text-emerald-700 px-2 py-1 rounded hover:bg-emerald-200">${grants.length}ê±´ ë°œê²¬</button>`
                                                : `<span class="text-slate-400 text-xs">ì—†ìŒ</span>`
                                            }
                                        </td>
                                        <td class="p-3 md:p-4">
                                            ${warnings.length > 0 
                                                ? `<span class="bg-red-100 text-red-700 px-2 py-1 rounded text-xs font-bold">${warnings.length}ê°œ ìœ í˜•</span>`
                                                : `<span class="text-slate-400 text-xs">-</span>`
                                            }
                                        </td>
                                        <td class="p-3 md:p-4 text-right space-x-1">
                                            <button onclick="addIncident(${emp.id})" class="text-amber-500 hover:bg-amber-50 px-2 py-1 rounded text-xs">ì´ìŠˆ</button>
                                            <button onclick="deleteEmployee(${emp.id})" class="text-red-500 hover:bg-red-50 px-2 py-1 rounded text-xs">ì‚­ì œ</button>
                                        </td>
                                    </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                        ${db.employees.length === 0 ? '<div class="p-8 text-center text-slate-400">ì§ì›ì„ ë“±ë¡í•´ì£¼ì„¸ìš”.</div>' : ''}
                    </div>
                </div>
            `;
        }

        // --- TIME & SAFETY ---
        function renderTime(container) {
            const today = new Date().toISOString().split('T')[0];
            const pendingLeaves = db.leaves.filter(l => l.status === 'pending');

            container.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Safety Clock-In -->
                    <div class="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-slate-100">
                        <h3 class="font-bold mb-4 text-base md:text-lg flex items-center gap-2">
                            <i class="fa-solid fa-shield-halved text-red-600"></i> 
                            ì•ˆì „ì ê²€ ì¶œê·¼
                        </h3>
                        <div class="space-y-3 mb-4">
                            <select id="time-emp-select" class="w-full border p-3 rounded text-sm bg-gray-50">
                                <option value="">ì§ì› ì„ íƒ</option>
                                ${db.employees.map(e => `<option value="${e.id}">${e.name}</option>`).join('')}
                            </select>
                            <input type="date" id="time-date" value="${today}" class="w-full border p-3 rounded text-sm bg-gray-50">
                        </div>
                        
                        <div id="safety-checks" class="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4 mb-4 hidden">
                            <div class="font-bold text-sm text-yellow-800 mb-3">âš ï¸ ì•ˆì „ì ê²€ ì²´í¬ (ì¤‘ëŒ€ì¬í•´ì²˜ë²Œë²•)</div>
                            <div class="space-y-2 text-sm">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" class="safety-check w-4 h-4" value="ì•ˆì „ëª¨ ì°©ìš©">
                                    <span>ì•ˆì „ëª¨ ì°©ìš© ì™„ë£Œ</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" class="safety-check w-4 h-4" value="ê¸°ê³„ ì ê²€">
                                    <span>ê¸°ê³„ ë° ì¥ë¹„ ì ê²€ ì™„ë£Œ</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" class="safety-check w-4 h-4" value="ì†Œí™”ê¸° ìœ„ì¹˜ í™•ì¸">
                                    <span>ì†Œí™”ê¸° ìœ„ì¹˜ í™•ì¸</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" class="safety-check w-4 h-4" value="ì•ˆì „êµìœ¡ ì´ìˆ˜">
                                    <span>ì•ˆì „êµìœ¡ ì´ìˆ˜ (ì›” 1íšŒ)</span>
                                </label>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="clockAction('in')" class="touch-btn bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold">
                                <i class="fa-solid fa-right-to-bracket"></i> ì¶œê·¼
                            </button>
                            <button onclick="clockAction('out')" class="touch-btn bg-slate-600 text-white rounded-lg hover:bg-slate-700 font-bold">
                                <i class="fa-solid fa-right-from-bracket"></i> í‡´ê·¼
                            </button>
                        </div>
                        <div class="mt-3 text-xs text-slate-400 text-center">
                            * ì¶œê·¼ ì‹œ ì•ˆì „ì ê²€ 3ê°œ ì´ìƒ ì²´í¬ í•„ìˆ˜
                        </div>
                    </div>

                    <!-- Today's Attendance -->
                    <div class="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-slate-100">
                        <h3 class="font-bold mb-4 text-base md:text-lg">ğŸ“‹ ê¸ˆì¼ ì¶œí‡´ê·¼ í˜„í™©</h3>
                        <div class="space-y-2 max-h-96 overflow-y-auto">
                            ${db.attendance.filter(a => a.date === today).map(a => {
                                const emp = db.employees.find(e => e.id == a.empId);
                                return `
                                    <div class="flex justify-between items-center p-3 bg-slate-50 rounded">
                                        <div>
                                            <span class="text-sm font-medium">${emp ? emp.name : 'Unknown'}</span>
                                            ${a.safetyChecks && a.safetyChecks.length > 0 ? `<span class="ml-2 text-xs text-green-600"><i class="fa-solid fa-shield-halved"></i> ${a.safetyChecks.length}ê°œ ì²´í¬</span>` : ''}
                                        </div>
                                        <div class="text-xs">
                                            <span class="text-blue-600 font-medium">${a.checkIn || '-'}</span> ~ 
                                            <span class="text-slate-600 font-medium">${a.checkOut || '-'}</span>
                                        </div>
                                    </div>
                                `;
                            }).join('') || '<div class="text-slate-400 text-sm text-center py-8">ê¸°ë¡ ì—†ìŒ</div>'}
                        </div>
                    </div>

                    <!-- Leave Requests -->
                    <div class="lg:col-span-2 bg-white p-4 md:p-6 rounded-xl shadow-sm border border-slate-100">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-base md:text-lg">ğŸ–ï¸ íœ´ê°€ ì‹ ì²­ ê´€ë¦¬</h3>
                            <button onclick="requestLeave()" class="text-sm bg-green-100 text-green-600 px-3 py-1.5 rounded hover:bg-green-200">+ íœ´ê°€ ì‹ ì²­</button>
                        </div>
                        ${pendingLeaves.length > 0 ? `
                        <div class="mb-4 p-4 bg-amber-50 border border-amber-200 rounded-lg">
                            <div class="font-bold text-sm text-amber-800 mb-2">ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ íœ´ê°€ (${pendingLeaves.length}ê±´)</div>
                            <div class="space-y-2">
                                ${pendingLeaves.map(leave => {
                                    const emp = db.employees.find(e => e.id == leave.empId);
                                    return `
                                    <div class="flex justify-between items-center p-2 bg-white rounded">
                                        <div class="text-sm">
                                            <span class="font-medium">${emp.name}</span> - ${leave.startDate} ~ ${leave.endDate} (${leave.days}ì¼)
                                        </div>
                                        <div class="space-x-2">
                                            <button onclick="approveLeave(${leave.id})" class="text-xs bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600">ìŠ¹ì¸</button>
                                            <button onclick="rejectLeave(${leave.id})" class="text-xs bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">ë°˜ë ¤</button>
                                        </div>
                                    </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        ` : ''}
                        <div class="text-xs text-slate-400">ì—°ì°¨ëŠ” ì…ì‚¬ 1ë…„ í›„ ìë™ ë°œìƒë©ë‹ˆë‹¤ (ë²•ì • ê¸°ì¤€)</div>
                    </div>
                </div>
            `;

            // Show safety checks when employee selected
            document.getElementById('time-emp-select')?.addEventListener('change', function() {
                const safetyDiv = document.getElementById('safety-checks');
                if (this.value) {
                    safetyDiv.classList.remove('hidden');
                } else {
                    safetyDiv.classList.add('hidden');
                }
            });
        }

        // --- PAYROLL & GRANTS ---
        function renderPayroll(container) {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth() + 1;

            const payrollData = db.employees.map(emp => {
                const calc = calculatePayroll(emp.id, year, month);
                const anomaly = calc ? detectPayrollAnomaly(emp.id, calc.netPay) : null;
                return { emp, calc, anomaly };
            });

            const totalPayroll = payrollData.reduce((sum, p) => sum + (p.calc ? p.calc.totalPay : 0), 0);

            container.innerHTML = `
                <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-4 md:p-6 print-area">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-3 mb-6 no-print">
                        <h3 class="font-bold text-base md:text-lg">ğŸ’° ${year}ë…„ ${month}ì›” ê¸‰ì—¬ëŒ€ì¥</h3>
                        <div class="flex gap-2 w-full md:w-auto">
                            <button onclick="downloadBankExcel()" class="flex-1 md:flex-none bg-green-600 text-white px-4 py-2 rounded text-sm hover:bg-green-700">
                                <i class="fa-solid fa-file-excel"></i> ì€í–‰ ì´ì²´íŒŒì¼
                            </button>
                            <button onclick="window.print()" class="flex-1 md:flex-none bg-slate-800 text-white px-4 py-2 rounded text-sm hover:bg-slate-900">
                                <i class="fa-solid fa-print"></i> ì¸ì‡„
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-4 p-4 bg-blue-50 rounded-lg text-sm no-print">
                        <div class="font-bold text-blue-800">ì´ ì§€ê¸‰ì•¡: ${formatCurrency(totalPayroll)}</div>
                        <div class="text-xs text-blue-600 mt-1">* ì‹¤ì œ ì´ì²´ì•¡ì€ ê³µì œ í›„ ì‹¤ìˆ˜ë ¹ì•¡ ê¸°ì¤€ì…ë‹ˆë‹¤</div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full text-xs md:text-sm text-left whitespace-nowrap">
                            <thead class="bg-slate-50 text-slate-500 border-b">
                                <tr>
                                    <th class="p-2 md:p-3">ì´ë¦„</th>
                                    <th class="p-2 md:p-3">êµ¬ë¶„</th>
                                    <th class="p-2 md:p-3">ê·¼ë¬´ì¼</th>
                                    <th class="p-2 md:p-3 text-right">ê¸°ë³¸ê¸‰</th>
                                    <th class="p-2 md:p-3 text-right">ìˆ˜ë‹¹</th>
                                    <th class="p-2 md:p-3 text-right">ê³µì œ</th>
                                    <th class="p-2 md:p-3 text-right font-bold">ì‹¤ìˆ˜ë ¹ì•¡</th>
                                    <th class="p-2 md:p-3 text-center no-print">ìƒíƒœ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${payrollData.map(({emp, calc, anomaly}) => {
                                    if (!calc) return '';
                                    return `
                                    <tr class="border-b border-slate-50 ${anomaly ? 'bg-red-50' : ''}">
                                        <td class="p-2 md:p-3 font-medium">${emp.name}</td>
                                        <td class="p-2 md:p-3">
                                            <span class="text-xs px-2 py-0.5 rounded ${calc.isFreelancer ? 'bg-purple-100 text-purple-700' : 'bg-green-100 text-green-700'}">
                                                ${emp.type}
                                            </span>
                                        </td>
                                        <td class="p-2 md:p-3">${calc.days}ì¼</td>
                                        <td class="p-2 md:p-3 text-right">${formatCurrency(calc.basePay)}</td>
                                        <td class="p-2 md:p-3 text-right text-blue-600">
                                            ${calc.isFreelancer ? '-' : `+${formatCurrency(calc.otPay + (calc.nightPay || 0))}`}
                                            ${calc.otHours > 0 ? `<div class="text-xs text-slate-400">ì—°ì¥ ${calc.otHours}h</div>` : ''}
                                        </td>
                                        <td class="p-2 md:p-3 text-right text-red-400">
                                            ${calc.isFreelancer 
                                                ? `-${formatCurrency(calc.tax.withholdingTax)} (3.3%)`
                                                : `-${formatCurrency(calc.totalDeduction)}`
                                            }
                                        </td>
                                        <td class="p-2 md:p-3 text-right font-bold text-slate-800">${formatCurrency(calc.netPay)}</td>
                                        <td class="p-2 md:p-3 text-center no-print">
                                            ${anomaly 
                                                ? `<span class="bg-red-100 text-red-700 px-2 py-0.5 rounded text-xs">${anomaly.msg}</span>`
                                                : `<span class="bg-green-100 text-green-700 px-2 py-0.5 rounded text-xs">ì •ìƒ</span>`
                                            }
                                        </td>
                                    </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-6 p-4 bg-yellow-50 text-yellow-800 text-xs rounded border border-yellow-100 no-print">
                        <i class="fa-solid fa-triangle-exclamation mr-1"></i>
                        <strong>ì£¼ì˜:</strong> ì—°ì¥/ì•¼ê°„ìˆ˜ë‹¹ì€ ê·¼íƒœ ê¸°ë¡ ê¸°ë°˜ ìë™ ê³„ì‚°(1.5ë°°)ì´ë©°, í”„ë¦¬ëœì„œëŠ” 3.3% ì›ì²œì§•ìˆ˜ë§Œ ì ìš©ë©ë‹ˆë‹¤.
                    </div>
                </div>
            `;
        }

        // --- ADMIN (Supplies & Docs) ---
        function renderAdmin(container) {
            const pendingSupplies = db.supplies.filter(s => s.status === 'pending');

            container.innerHTML = `
                <div class="grid grid-cols-1 gap-6">
                    <!-- Supply Requests -->
                    <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-4 md:p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-base md:text-lg">ğŸ“¦ ì†Œëª¨í’ˆ ìš”ì²­ ê´€ë¦¬</h3>
                            <button onclick="requestSupply()" class="text-sm bg-blue-100 text-blue-600 px-3 py-1.5 rounded hover:bg-blue-200">+ ìš”ì²­í•˜ê¸°</button>
                        </div>
                        ${pendingSupplies.length > 0 ? `
                        <div class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                            <div class="font-bold text-sm text-blue-800 mb-3">ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ (${pendingSupplies.length}ê±´)</div>
                            <div class="space-y-2">
                                ${pendingSupplies.map(supply => {
                                    const emp = db.employees.find(e => e.id == supply.empId);
                                    return `
                                    <div class="flex justify-between items-center p-3 bg-white rounded">
                                        <div class="text-sm">
                                            <span class="font-medium">${emp ? emp.name : 'ë¯¸ìƒ'}</span> - 
                                            <span class="text-slate-600">${supply.item} (${supply.qty}ê°œ)</span>
                                            <div class="text-xs text-slate-400 mt-1">${supply.date}</div>
                                        </div>
                                        <button onclick="approveSupply(${supply.id})" class="text-xs bg-green-500 text-white px-3 py-1.5 rounded hover:bg-green-600">êµ¬ë§¤ ì™„ë£Œ</button>
                                    </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        ` : '<div class="text-slate-400 text-sm text-center py-8">ìš”ì²­ ì—†ìŒ</div>'}
                    </div>

                    <!-- Document Generation -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                            <div class="w-12 h-12 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mb-4 text-xl">
                                <i class="fa-solid fa-file-contract"></i>
                            </div>
                            <h3 class="font-bold text-base mb-2">ê·¼ë¡œê³„ì•½ì„œ</h3>
                            <p class="text-xs text-slate-500 mb-4">ì§ì› ì •ë³´ ê¸°ë°˜ ìë™ ì™„ì„±</p>
                            <select id="contract-emp" class="w-full border p-2 rounded text-sm mb-3 bg-gray-50">
                                <option value="">ì§ì› ì„ íƒ...</option>
                                ${db.employees.map(e => `<option value="${e.id}">${e.name}</option>`).join('')}
                            </select>
                            <button onclick="generateContract()" class="w-full bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700 text-sm">
                                <i class="fa-solid fa-file-pdf"></i> PDF ìƒì„±
                            </button>
                        </div>

                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                            <div class="w-12 h-12 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center mb-4 text-xl">
                                <i class="fa-solid fa-certificate"></i>
                            </div>
                            <h3 class="font-bold text-base mb-2">ì¬ì§ì¦ëª…ì„œ</h3>
                            <p class="text-xs text-slate-500 mb-4">ì§ì¸ í¬í•¨ ì¦‰ì‹œ ë°œê¸‰</p>
                            <select id="cert-emp" class="w-full border p-2 rounded text-sm mb-3 bg-gray-50">
                                <option value="">ì§ì› ì„ íƒ...</option>
                                ${db.employees.map(e => `<option value="${e.id}">${e.name}</option>`).join('')}
                            </select>
                            <button onclick="generateCertificate()" class="w-full bg-emerald-600 text-white py-2 rounded hover:bg-emerald-700 text-sm">
                                <i class="fa-solid fa-file-pdf"></i> ë°œê¸‰í•˜ê¸°
                            </button>
                        </div>

                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                            <div class="w-12 h-12 bg-amber-100 text-amber-600 rounded-full flex items-center justify-center mb-4 text-xl">
                                <i class="fa-solid fa-book"></i>
                            </div>
                            <h3 class="font-bold text-base mb-2">íšŒì‚¬ ìœ„í‚¤</h3>
                            <p class="text-xs text-slate-500 mb-4">ì‚¬ë‚´ ê·œì • ë° ê³µì§€</p>
                            <button onclick="showWiki()" class="w-full bg-amber-600 text-white py-2 rounded hover:bg-amber-700 text-sm">
                                <i class="fa-solid fa-eye"></i> ë³´ê¸°
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- SETTINGS ---
        function renderSettings(container) {
            container.innerHTML = `
                <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-4 md:p-6 max-w-3xl">
                    <h3 class="font-bold text-lg md:text-xl mb-6">âš™ï¸ ì‹œìŠ¤í…œ ì„¤ì •</h3>
                    
                    <div class="space-y-6">
                        <div class="border-b pb-4">
                            <h4 class="font-bold text-sm text-slate-800 mb-3">ğŸ¢ íšŒì‚¬ ì •ë³´</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-medium text-slate-700 mb-1">íšŒì‚¬ëª…</label>
                                    <input type="text" id="set-comp-name" value="${db.company.name}" class="w-full border p-2 rounded text-sm bg-gray-50">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-slate-700 mb-1">ëŒ€í‘œì</label>
                                    <input type="text" id="set-comp-ceo" value="${db.company.ceo}" class="w-full border p-2 rounded text-sm bg-gray-50">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-slate-700 mb-1">ì‚¬ì—…ìë²ˆí˜¸</label>
                                    <input type="text" id="set-comp-biz" value="${db.company.bizNo}" class="w-full border p-2 rounded text-sm bg-gray-50">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-slate-700 mb-1">ì „í™”ë²ˆí˜¸</label>
                                    <input type="text" id="set-comp-tel" value="${db.company.tel}" class="w-full border p-2 rounded text-sm bg-gray-50">
                                </div>
                            </div>
                            <div class="mt-3">
                                <label class="block text-xs font-medium text-slate-700 mb-1">ì£¼ì†Œ</label>
                                <input type="text" id="set-comp-addr" value="${db.company.address}" class="w-full border p-2 rounded text-sm bg-gray-50">
                            </div>
                        </div>

                        <div class="border-b pb-4">
                            <h4 class="font-bold text-sm text-slate-800 mb-3">ğŸ’° ê¸‰ì—¬ ê¸°ì¤€ (2026)</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs text-slate-500 mb-1">ìµœì €ì‹œê¸‰ (ì›)</label>
                                    <input type="number" id="set-min-wage" value="${db.settings.minWage}" class="w-full border p-2 rounded text-sm bg-gray-50">
                                </div>
                                <div>
                                    <label class="block text-xs text-slate-500 mb-1">ì£¼ë‹¹ ë²•ì •ì‹œê°„</label>
                                    <input type="number" value="${db.settings.weeklyHours}" class="w-full border p-2 rounded text-sm bg-gray-100" disabled>
                                </div>
                            </div>
                            <div class="mt-3 p-3 bg-blue-50 rounded text-xs text-blue-700">
                                <i class="fa-solid fa-info-circle"></i> 
                                2026ë…„ ìµœì €ì‹œê¸‰: ${formatCurrency(MIN_WAGE_2026)}, ì›”í™˜ì‚°: ${formatCurrency(MIN_WAGE_MONTHLY)}
                            </div>
                        </div>

                        <div class="border-b pb-4">
                            <h4 class="font-bold text-sm text-slate-800 mb-3">ğŸ¥ 4ëŒ€ë³´í—˜ ìš”ìœ¨ (%)</h4>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>êµ­ë¯¼ì—°ê¸ˆ: ${db.settings.insuranceRates.pension}%</div>
                                <div>ê±´ê°•ë³´í—˜: ${db.settings.insuranceRates.health}%</div>
                                <div>ì¥ê¸°ìš”ì–‘: ${db.settings.insuranceRates.care}% (ê±´ê°•ë³´í—˜ ê¸°ì¤€)</div>
                                <div>ê³ ìš©ë³´í—˜: ${db.settings.insuranceRates.employment}%</div>
                            </div>
                        </div>

                        <div>
                            <button onclick="saveSettings()" class="w-full bg-slate-800 text-white py-3 rounded-lg font-bold hover:bg-slate-900 text-sm md:text-base">
                                <i class="fa-solid fa-save"></i> ì„¤ì • ì €ì¥í•˜ê¸°
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // ==========================================
        // 8. Action Functions
        // ==========================================

        // Employee Management
        function addEmployeePrompt() {
            const name = prompt("ì´ë¦„:");
            if(!name) return;
            const type = prompt("êµ¬ë¶„ (ì •ê·œì§/ê³„ì•½ì§/í”„ë¦¬ëœì„œ):", "ì •ê·œì§");
            const salary = prompt("ì›” ê¸‰ì—¬(ì›):", MIN_WAGE_MONTHLY);
            const joinDate = prompt("ì…ì‚¬ì¼ (YYYY-MM-DD):", new Date().toISOString().split('T')[0]);
            const birthDate = prompt("ìƒë…„ì›”ì¼ (YYYY-MM-DD):", "1995-01-01");
            const hasChild = confirm("ìë…€ê°€ ìˆìŠµë‹ˆê¹Œ? (ìœ¡ì•„íœ´ì§ ì§€ì›ê¸ˆ ì²´í¬ìš©)");
            const contractEnd = type === 'ê³„ì•½ì§' ? prompt("ê³„ì•½ì¢…ë£Œì¼ (YYYY-MM-DD):", "") : null;

            db.employees.push({
                id: Date.now(),
                name, type, salary: parseInt(salary) || 0,
                joinDate, birthDate, hasChild, contractEnd,
                position: "ì‚¬ì›"
            });
            saveDB();
            renderTab('people');
        }

        function deleteEmployee(id) {
            if(confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                db.employees = db.employees.filter(e => e.id !== id);
                saveDB();
                renderTab('people');
            }
        }

        function addIncident(empId) {
            const emp = db.employees.find(e => e.id == empId);
            const type = prompt(`${emp.name}ë‹˜ì˜ ì´ìŠˆ ìœ í˜•:\n(ì˜ˆ: ì§€ê°, ë¬´ë‹¨ê²°ê·¼, ì—…ë¬´íƒœë§Œ)`);
            if (!type) return;
            
            const memo = prompt("ìƒì„¸ ë‚´ìš©:");
            db.incidents.push({
                id: Date.now(),
                empId,
                type,
                date: new Date().toISOString().split('T')[0],
                memo: memo || ''
            });

            const warnings = checkThreeStrikes(empId);
            if (warnings.length > 0) {
                const warningMsg = warnings.map(w => `${w.type}: ${w.count}íšŒ`).join(', ');
                alert(`âš ï¸ Three Strikes ê²½ê³ !\n\n${emp.name}ë‹˜ì€ ë‹¤ìŒ ì´ìŠˆê°€ 3íšŒ ì´ìƒ ëˆ„ì ë˜ì—ˆìŠµë‹ˆë‹¤:\n${warningMsg}\n\nì„œë©´ ê²½ê³ ì¥(ì‹œë§ì„œ)ì„ ë°œí–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
                // TODO: Generate warning letter
            }

            saveDB();
            renderTab('people');
        }

        function showGrantDetail(empId) {
            const emp = db.employees.find(e => e.id == empId);
            const grants = analyzeGrants(emp);
            
            let msg = `ğŸ’° ${emp.name}ë‹˜ ì§€ì›ê¸ˆ ë§¤ì¹­ ê²°ê³¼\n\n`;
            grants.forEach((g, i) => {
                msg += `${i+1}. ${g.name}\n`;
                msg += `   ê¸ˆì•¡: ${g.amount}\n`;
                msg += `   ì‹ ì²­ê¸°í•œ: ${g.deadline}\n`;
                msg += `   í•„ìš”ì„œë¥˜: ${g.docs.join(', ')}\n\n`;
            });
            msg += `\nğŸ“„ ì›í´ë¦­ ì„œë¥˜íŒ¨í‚¤ì§€ë¥¼ ë‹¤ìš´ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
            
            if (confirm(msg)) {
                downloadGrantDocPack(empId);
            }
        }

        function downloadGrantDocPack(empId) {
            const emp = db.employees.find(e => e.id == empId);
            // This would generate a PDF with contract + payroll + attendance
            alert(`${emp.name}ë‹˜ì˜ ì§€ì›ê¸ˆ ì‹ ì²­ ì„œë¥˜ íŒ¨í‚¤ì§€ (ê·¼ë¡œê³„ì•½ì„œ + ì„ê¸ˆëŒ€ì¥ + ì¶œí‡´ê·¼ê¸°ë¡)ì„ ìƒì„±í•©ë‹ˆë‹¤.\n\nì‹¤ì œ êµ¬í˜„ ì‹œ jsPDFë¡œ í†µí•© PDF ìƒì„± ì˜ˆì •`);
        }

        // Time & Attendance
        function clockAction(type) {
            const empId = document.getElementById('time-emp-select').value;
            const date = document.getElementById('time-date').value;
            if(!empId) return alert("ì§ì›ì„ ì„ íƒí•˜ì„¸ìš”.");

            if (type === 'in') {
                // Check safety checks
                const checks = Array.from(document.querySelectorAll('.safety-check:checked')).map(cb => cb.value);
                if (checks.length < 3) {
                    return alert("âš ï¸ ì•ˆì „ì ê²€ì„ ìµœì†Œ 3ê°œ ì´ìƒ ì²´í¬í•´ì£¼ì„¸ìš”!\n(ì¤‘ëŒ€ì¬í•´ì²˜ë²Œë²• ì¤€ìˆ˜)");
                }

                let record = db.attendance.find(a => a.empId == empId && a.date === date);
                if (!record) {
                    record = { id: Date.now(), empId, date, safetyChecks: checks };
                    db.attendance.push(record);
                } else {
                    record.safetyChecks = checks;
                }
                
                const now = new Date();
                record.checkIn = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
                
                saveDB();
                alert(`âœ… ì¶œê·¼ ì²˜ë¦¬ ì™„ë£Œ!\nì•ˆì „ì ê²€ ${checks.length}ê°œ í•­ëª© ê¸°ë¡ë¨`);
            } else {
                let record = db.attendance.find(a => a.empId == empId && a.date === date);
                if (!record) {
                    alert("ì¶œê·¼ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }
                const now = new Date();
                record.checkOut = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
                saveDB();
                alert("âœ… í‡´ê·¼ ì²˜ë¦¬ ì™„ë£Œ!");
            }

            renderTab('time');
        }

        function requestLeave() {
            const empId = prompt("ì§ì› ID (ì§ì› ëª©ë¡ ì°¸ì¡°):");
            if (!empId) return;
            const startDate = prompt("ì‹œì‘ì¼ (YYYY-MM-DD):");
            const endDate = prompt("ì¢…ë£Œì¼ (YYYY-MM-DD):");
            const days = prompt("íœ´ê°€ ì¼ìˆ˜:", "1");

            db.leaves.push({
                id: Date.now(),
                empId: parseInt(empId),
                type: 'ì—°ì°¨',
                startDate, endDate,
                days: parseInt(days),
                status: 'pending'
            });
            saveDB();
            renderTab('time');
        }

        function approveLeave(id) {
            const leave = db.leaves.find(l => l.id === id);
            leave.status = 'approved';
            saveDB();
            renderTab('time');
        }

        function rejectLeave(id) {
            if (confirm("ì •ë§ ë°˜ë ¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                const leave = db.leaves.find(l => l.id === id);
                leave.status = 'rejected';
                saveDB();
                renderTab('time');
            }
        }

        // Supply Management
        function requestSupply() {
            const empId = prompt("ì§ì› ID:");
            if (!empId) return;
            const item = prompt("í’ˆëª©ëª… (ì˜ˆ: ì½”íŒ…ì¥ê°‘, ë°•ìŠ¤í…Œì´í”„):");
            const qty = prompt("ìˆ˜ëŸ‰:", "10");

            db.supplies.push({
                id: Date.now(),
                empId: parseInt(empId),
                item, qty: parseInt(qty),
                status: 'pending',
                date: new Date().toISOString().split('T')[0]
            });
            saveDB();
            renderTab('admin');
        }

        function approveSupply(id) {
            const supply = db.supplies.find(s => s.id === id);
            supply.status = 'approved';
            saveDB();
            alert("êµ¬ë§¤ ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
            renderTab('admin');
        }

        // Document Generation
        function generateContract() {
            const empId = document.getElementById('contract-emp').value;
            if(!empId) return alert("ì§ì›ì„ ì„ íƒí•˜ì„¸ìš”.");
            
            const emp = db.employees.find(e => e.id == empId);
            const w = window.open('', '_blank');
            w.document.write(`
                <html>
                <head>
                    <meta charset="UTF-8">
                    <style>
                        body { font-family: 'Malgun Gothic', sans-serif; padding: 40px; line-height: 1.8; }
                        h1 { text-align: center; margin-bottom: 40px; }
                        .content { margin: 20px 0; }
                        .signature { display: flex; justify-content: space-between; margin-top: 60px; }
                    </style>
                </head>
                <body>
                    <h1>í‘œì¤€ê·¼ë¡œê³„ì•½ì„œ</h1>
                    <p><strong>${db.company.name}</strong>(ì´í•˜ "ê°‘")ê³¼ <strong>${emp.name}</strong>(ì´í•˜ "ì„")ì€ ë‹¤ìŒê³¼ ê°™ì´ ê·¼ë¡œê³„ì•½ì„ ì²´ê²°í•œë‹¤.</p>
                    
                    <div class="content">
                        <p><strong>ì œ1ì¡° (ê³„ì•½ê¸°ê°„)</strong></p>
                        <p>ê·¼ë¡œê°œì‹œì¼: ${emp.joinDate}</p>
                        ${emp.contractEnd ? `<p>ê³„ì•½ì¢…ë£Œì¼: ${emp.contractEnd}</p>` : '<p>ê¸°ê°„ì˜ ì •í•¨ì´ ì—†ëŠ” ê·¼ë¡œê³„ì•½</p>'}
                        
                        <p><strong>ì œ2ì¡° (ê·¼ë¬´ì¥ì†Œ ë° ì—…ë¬´)</strong></p>
                        <p>ê·¼ë¬´ì¥ì†Œ: ${db.company.address}</p>
                        <p>ì—…ë¬´ë‚´ìš©: ${emp.position} ì—…ë¬´ ì¼ì²´</p>
                        
                        <p><strong>ì œ3ì¡° (ê·¼ë¡œì‹œê°„)</strong></p>
                        <p>ì†Œì •ê·¼ë¡œì‹œê°„: 09:00 ~ 18:00 (íœ´ê²Œì‹œê°„ 12:00~13:00, 1ì‹œê°„)</p>
                        <p>ì£¼ë‹¹ ${db.settings.weeklyHours}ì‹œê°„ ê·¼ë¬´</p>
                        
                        <p><strong>ì œ4ì¡° (ì„ê¸ˆ)</strong></p>
                        <p>ì›” ê¸‰ì—¬: <strong>${formatCurrency(emp.salary)}</strong> (ì„¸ì „)</p>
                        <p>ì§€ê¸‰ì¼: ë§¤ì›” 25ì¼</p>
                        ${emp.type !== 'í”„ë¦¬ëœì„œ' ? '<p>ì—°ì¥/ì•¼ê°„/íœ´ì¼ ê·¼ë¡œ ì‹œ ê°€ì‚°ìˆ˜ë‹¹ ì§€ê¸‰ (í†µìƒì„ê¸ˆì˜ 1.5ë°°)</p>' : ''}
                        
                        <p><strong>ì œ5ì¡° (íœ´ê°€)</strong></p>
                        ${emp.type === 'ì •ê·œì§' ? '<p>ì—°ì°¨ìœ ê¸‰íœ´ê°€: ê·¼ë¡œê¸°ì¤€ë²•ì—ì„œ ì •í•˜ëŠ” ë°”ì— ë”°ë¦„</p>' : '<p>ì—°ì°¨: ê³„ì•½ì„œì— ëª…ì‹œëœ ë°”ì— ë”°ë¦„</p>'}
                        
                        <p><strong>ì œ6ì¡° (ì‚¬íšŒë³´í—˜)</strong></p>
                        ${emp.type === 'í”„ë¦¬ëœì„œ' 
                            ? '<p>í”„ë¦¬ëœì„œ ê³„ì•½ìœ¼ë¡œ 4ëŒ€ë³´í—˜ ë¯¸ì ìš©, ì†Œë“ì„¸ 3.3% ì›ì²œì§•ìˆ˜</p>'
                            : '<p>êµ­ë¯¼ì—°ê¸ˆ, ê±´ê°•ë³´í—˜, ê³ ìš©ë³´í—˜, ì‚°ì¬ë³´í—˜ ê°€ì…</p>'
                        }
                    </div>
                    
                    <p style="text-align: center; margin-top: 60px;">2026ë…„ __ì›” __ì¼</p>
                    
                    <div class="signature">
                        <div>
                            <p><strong>(ê°‘) ì‚¬ì—…ì£¼</strong></p>
                            <p>ìƒí˜¸: ${db.company.name}</p>
                            <p>ëŒ€í‘œì: ${db.company.ceo} (ì¸)</p>
                            <p>ì£¼ì†Œ: ${db.company.address}</p>
                        </div>
                        <div>
                            <p><strong>(ì„) ê·¼ë¡œì</strong></p>
                            <p>ì„±ëª…: ${emp.name} (ì¸)</p>
                            <p>ìƒë…„ì›”ì¼: ${emp.birthDate}</p>
                        </div>
                    </div>
                </body>
                </html>
            `);
            w.document.close();
        }

        function generateCertificate() {
            const empId = document.getElementById('cert-emp').value;
            if(!empId) return alert("ì§ì›ì„ ì„ íƒí•˜ì„¸ìš”.");
            
            const emp = db.employees.find(e => e.id == empId);
            const w = window.open('', '_blank');
            w.document.write(`
                <html>
                <head>
                    <meta charset="UTF-8">
                    <style>
                        body { font-family: 'Malgun Gothic', sans-serif; padding: 60px; line-height: 2; }
                        h1 { text-align: center; font-size: 32px; margin-bottom: 60px; }
                        .seal { text-align: right; margin-top: 40px; font-size: 18px; color: #dc2626; }
                    </style>
                </head>
                <body>
                    <h1>ì¬ì§ì¦ëª…ì„œ</h1>
                    
                    <p>ì•„ë˜ ì‚¬ëŒì€ ë³¸ íšŒì‚¬ì˜ ì§ì›ìœ¼ë¡œ ì¬ì§ ì¤‘ì„ì„ ì¦ëª…í•©ë‹ˆë‹¤.</p>
                    
                    <div style="margin: 40px 0;">
                        <p>ì„±ëª…: <strong>${emp.name}</strong></p>
                        <p>ìƒë…„ì›”ì¼: ${emp.birthDate}</p>
                        <p>ì§ìœ„: ${emp.position}</p>
                        <p>ì…ì‚¬ì¼: ${emp.joinDate}</p>
                        <p>ê·¼ë¬´ë¶€ì„œ: ê²½ì˜ì§€ì›íŒ€</p>
                    </div>
                    
                    <p style="margin-top: 60px;">ìœ„ì™€ ê°™ì´ ì¦ëª…í•˜ì—¬ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.</p>
                    
                    <p style="text-align: center; margin-top: 80px; font-size: 20px;">${new Date().toLocaleDateString('ko-KR', {year: 'numeric', month: 'long', day: 'numeric'})}</p>
                    
                    <div class="seal">
                        <p><strong>${db.company.name}</strong></p>
                        <p>ëŒ€í‘œì´ì‚¬: ${db.company.ceo}</p>
                        <p style="font-size: 40px; margin-top: 20px;">[ì§ì¸]</p>
                    </div>
                </body>
                </html>
            `);
            w.document.close();
        }

        function showWiki() {
            let content = "ğŸ“š íšŒì‚¬ ìœ„í‚¤\n\n";
            db.wiki.forEach(w => {
                content += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
                content += `ğŸ“Œ ${w.title}\n\n`;
                content += `${w.content}\n\n`;
            });
            alert(content);
        }

        // Bank Transfer Excel
        function downloadBankExcel() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth() + 1;

            const data = db.employees.map(emp => {
                const calc = calculatePayroll(emp.id, year, month);
                return {
                    'ì´ë¦„': emp.name,
                    'ê³„ì¢Œë²ˆí˜¸': emp.bankAccount || 'ë¯¸ë“±ë¡',
                    'ì´ì²´ê¸ˆì•¡': calc ? calc.netPay : 0,
                    'ë©”ëª¨': `${month}ì›” ê¸‰ì—¬`
                };
            });

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "ê¸‰ì—¬ì´ì²´");
            XLSX.writeFile(wb, `ê¸‰ì—¬ì´ì²´_${year}ë…„${month}ì›”.xlsx`);
            alert("âœ… ì€í–‰ ì´ì²´ìš© ì—‘ì…€ íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!");
        }

        // Task Management
        function addTaskPrompt() {
            const title = prompt("í•  ì¼ ë‚´ìš©:");
            if(!title) return;
            const deadline = prompt("ë§ˆê°ì¼ (YYYY-MM-DD, ì„ íƒì‚¬í•­):", "");
            db.tasks.push({ 
                id: Date.now(), 
                title, 
                status: "todo", 
                deadline: deadline || null,
                recurring: false
            });
            saveDB();
            renderTab('dashboard');
        }

        function moveTask(id) {
            const task = db.tasks.find(t => t.id === id);
            if (task.status === 'todo') task.status = 'doing';
            else if (task.status === 'doing') task.status = 'done';
            else return; // Can't move from done
            saveDB();
            renderTab('dashboard');
        }

        function deleteTask(id) {
            db.tasks = db.tasks.filter(t => t.id !== id);
            saveDB();
            renderTab('dashboard');
        }

        // Settings
        function saveSettings() {
            db.company.name = document.getElementById('set-comp-name').value;
            db.company.ceo = document.getElementById('set-comp-ceo').value;
            db.company.bizNo = document.getElementById('set-comp-biz').value;
            db.company.tel = document.getElementById('set-comp-tel').value;
            db.company.address = document.getElementById('set-comp-addr').value;
            db.settings.minWage = parseInt(document.getElementById('set-min-wage').value);
            saveDB();
            alert("âœ… ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }

        // Backup & Restore
        function backupData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db, null, 2));
            const anchor = document.createElement('a');
            anchor.setAttribute("href", dataStr);
            anchor.setAttribute("download", `SMB_ERP_Backup_${new Date().toISOString().split('T')[0]}.json`);
            document.body.appendChild(anchor);
            anchor.click();
            anchor.remove();
            alert("âœ… ë°±ì—… íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!");
        }

        function restoreData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = event => {
                    try {
                        const restored = JSON.parse(event.target.result);
                        if (confirm("ê¸°ì¡´ ë°ì´í„°ë¥¼ ëª¨ë‘ ë®ì–´ì”ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                            db = restored;
                            saveDB();
                            alert("âœ… ë°ì´í„°ê°€ ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
                            location.reload();
                        }
                    } catch (err) {
                        alert("âŒ ì˜ëª»ëœ íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤.");
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // ==========================================
        // 9. Initialize
        // ==========================================
        
        document.getElementById('current-date').innerText = new Date().toLocaleDateString('ko-KR', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric', 
            weekday: 'long' 
        });

        updateBadges();
        renderTab('dashboard');

        // Auto-save every 30 seconds
        setInterval(() => {
            console.log('Auto-save triggered');
            saveDB();
        }, 30000);

    </script>
</body>
</html>

