<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì „êµ­ íŒŒíŠ¸ë„ˆ ê³µë°© ì°¾ê¸° - í”„ë ˆìŠ¤ì½”21</title>
  
  <!-- ë„¤ì´ë²„ ì§€ë„ API (ìºì‹œ ë¬´ì‹œ) -->
  <script>
    // ë„¤ì´ë²„ ì§€ë„ API ë™ì  ë¡œë“œ
    (function() {
      var script = document.createElement('script');
      script.type = 'text/javascript';
      script.src = 'https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=bfp8odep5r&t=' + Date.now();
      script.async = true;
      script.onerror = function() {
        console.error('âŒ ë„¤ì´ë²„ ì§€ë„ API ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹¤íŒ¨');
        window.naverMapLoadError = true;
      };
      document.head.appendChild(script);
    })();
  </script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Apple SD Gothic Neo', sans-serif; background: #F9F8F5; }
    
    .header { background: linear-gradient(135deg, #7B8E7E 0%, #5A6B5D 100%); color: white; padding: 48px 20px; text-align: center; }
    .header h1 { font-size: 32px; margin-bottom: 12px; }
    .header p { font-size: 16px; opacity: 0.95; }
    
    .status { max-width: 1280px; margin: 20px auto; padding: 20px; background: white; border-radius: 12px; text-align: center; }
    .status.loading { background: #E3F2FD; color: #1976D2; }
    .status.error { background: #FFEBEE; color: #D32F2F; }
    .status.success { background: #E8F5E9; color: #388E3C; }
    
    .container { max-width: 1280px; margin: 20px auto; padding: 0 20px; }
    
    .filters { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .filter-group { margin-bottom: 16px; }
    .filter-label { font-size: 14px; font-weight: 600; color: #666; margin-bottom: 8px; display: block; }
    .filter-btns { display: flex; gap: 8px; flex-wrap: wrap; }
    .filter-btn { padding: 10px 16px; background: #F5F5F5; border: 2px solid #E0E0E0; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
    .filter-btn:hover { background: #7B8E7E; color: white; border-color: #7B8E7E; }
    .filter-btn.active { background: #7B8E7E; color: white; border-color: #7B8E7E; font-weight: 600; }
    
    .content { display: grid; grid-template-columns: 350px 1fr; gap: 20px; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 16px rgba(0,0,0,0.1); }
    
    .list { background: #FFFEF9; max-height: 600px; overflow-y: auto; padding: 20px; }
    .list-header { font-size: 16px; font-weight: 600; color: #7B8E7E; margin-bottom: 16px; }
    .workshop-card { background: white; padding: 16px; margin-bottom: 12px; border-radius: 8px; cursor: pointer; transition: all 0.3s; border: 2px solid transparent; }
    .workshop-card:hover, .workshop-card.active { background: #7B8E7E; color: white; border-color: #7B8E7E; transform: translateX(4px); }
    .workshop-card .badge { display: inline-block; background: #B5A48B; color: white; padding: 4px 10px; border-radius: 4px; font-size: 11px; margin-bottom: 8px; }
    .workshop-card:hover .badge { background: white; color: #7B8E7E; }
    .workshop-card .name { font-size: 16px; font-weight: 600; margin-bottom: 6px; }
    .workshop-card .genres { font-size: 13px; color: #666; margin-bottom: 6px; }
    .workshop-card:hover .genres { color: white; opacity: 0.9; }
    .workshop-card .address { font-size: 13px; color: #666; margin-bottom: 12px; }
    .workshop-card:hover .address { color: white; opacity: 0.85; }
    .workshop-card .contact { display: flex; gap: 8px; }
    .workshop-card .contact-btn { flex: 1; padding: 8px; background: #F5F5F5; border-radius: 6px; font-size: 12px; text-align: center; cursor: pointer; }
    .workshop-card:hover .contact-btn { background: white; color: #7B8E7E; }
    
    .map-wrapper { position: relative; height: 600px; }
    #map { width: 100%; height: 100%; }
    .map-loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; font-size: 18px; color: #666; }
    
    @media (max-width: 1024px) {
      .content { grid-template-columns: 1fr; }
      .list { max-height: 400px; }
    }
  </style>
</head>
<body>
  
  <div class="header">
    <h1>ğŸ—ºï¸ ì „êµ­ íŒŒíŠ¸ë„ˆ ê³µë°© ì°¾ê¸°</h1>
    <p>ì´ì§„ì„  ì¥ì¸ì˜ ê³µì‹ ì¸ì¦ì„ ë°›ì€ ì „êµ­ì˜ íŒŒíŠ¸ë„ˆ ê³µë°©ë“¤ì„ ë§Œë‚˜ë³´ì„¸ìš”</p>
  </div>
  
  <div id="status" class="status loading">
    <h3>ğŸ“Š ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</h3>
    <p>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
  </div>
  
  <div class="container">
    <div class="filters">
      <div class="filter-group">
        <span class="filter-label">ğŸ“ ì§€ì—­</span>
        <div class="filter-btns" id="regionFilters">
          <button class="filter-btn active" data-region="all">ì „ì²´</button>
        </div>
      </div>
      <div class="filter-group">
        <span class="filter-label">ğŸ¨ ê³µì˜ˆ ì¢…ë¥˜</span>
        <div class="filter-btns" id="genreFilters">
          <button class="filter-btn active" data-genre="all">ì „ì²´</button>
        </div>
      </div>
    </div>
    
    <div class="content">
      <div class="list">
        <div class="list-header"><span id="count">0</span>ê°œì˜ íŒŒíŠ¸ë„ˆ ê³µë°©</div>
        <div id="workshopList"></div>
      </div>
      <div class="map-wrapper">
        <div id="map"></div>
        <div class="map-loading" id="mapLoading">ğŸ—ºï¸<br>ì§€ë„ ë¡œë”© ì¤‘...</div>
      </div>
    </div>
  </div>
  
  <script>
    // =============================================
    // ğŸ”§ ì„¤ì • (ì—¬ê¸°ë§Œ ìˆ˜ì •í•˜ì„¸ìš”!)
    // =============================================
    const CONFIG = {
      // êµ¬ê¸€ ì‹œíŠ¸ API URL (Apps Script ì›¹ ì•± URL)
      GOOGLE_SHEET_API: 'https://script.google.com/macros/s/AKfycbxSzu3XpVNMC4aHFzlZOCE--BmpH3b8y57NAfLnF2gxdjH93RgF4f96Z44gxSTo7rl1/exec',
      
      // ë””ë²„ê·¸ ëª¨ë“œ
      DEBUG: true
    };
    
    // =============================================
    // ì „ì—­ ë³€ìˆ˜
    // =============================================
    let workshopsData = [];
    let naverMap = null;
    let markers = [];
    let currentFilters = { region: 'all', genre: 'all' };
    
    // =============================================
    // ìœ í‹¸ë¦¬í‹°
    // =============================================
    function log(...args) {
      if (CONFIG.DEBUG) console.log('[íŒŒíŠ¸ë„ˆë§µ]', ...args);
    }
    
    function showStatus(type, title, msg) {
      const el = document.getElementById('status');
      el.className = `status ${type}`;
      el.innerHTML = `<h3>${title}</h3><p>${msg}</p>`;
      el.style.display = 'block';
    }
    
    function hideStatus() {
      document.getElementById('status').style.display = 'none';
    }
    
    // =============================================
    // ë°ì´í„° ë¡œë“œ
    // =============================================
    async function loadData() {
      log('ë°ì´í„° ë¡œë“œ ì‹œì‘');
      showStatus('loading', 'ğŸ“Š ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...', 'ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.');
      
      try {
        const response = await fetch(CONFIG.GOOGLE_SHEET_API);
        log('ì‘ë‹µ ë°›ìŒ:', response.status);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        log('ë°ì´í„°:', data);
        
        if (data.error || !data.workshops) {
          throw new Error(data.message || 'ë°ì´í„° í˜•ì‹ ì˜¤ë¥˜');
        }
        
        workshopsData = data.workshops;
        
        if (workshopsData.length === 0) {
          showStatus('error', 'âš ï¸ í‘œì‹œí•  ê³µë°©ì´ ì—†ìŠµë‹ˆë‹¤', 'êµ¬ê¸€ ì‹œíŠ¸ì— ë°ì´í„°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }
        
        // í•„í„° ìƒì„±
        if (data.regions && data.genres) {
          createFilters(data.regions, data.genres);
        }
        
        hideStatus();
        renderList();
        
        if (naverMap) {
          createMarkers();
        }
        
        showStatus('success', 'âœ… ë¡œë“œ ì™„ë£Œ!', `${workshopsData.length}ê°œì˜ íŒŒíŠ¸ë„ˆ ê³µë°©ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤.`);
        setTimeout(hideStatus, 2000);
        
      } catch (err) {
        log('ì—ëŸ¬:', err);
        showStatus('error', 
          'âŒ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤',
          `ì˜¤ë¥˜: ${err.message}<br><br>
          <strong>í™•ì¸ì‚¬í•­:</strong><br>
          1. êµ¬ê¸€ ì‹œíŠ¸ API URLì´ ì˜¬ë°”ë¥¸ê°€ìš”?<br>
          2. Apps Scriptê°€ "ëª¨ë“  ì‚¬ìš©ì"ë¡œ ë°°í¬ë˜ì—ˆë‚˜ìš”?<br>
          3. ë¸Œë¼ìš°ì € ì½˜ì†”(F12)ì—ì„œ ìƒì„¸ ì˜¤ë¥˜ë¥¼ í™•ì¸í•˜ì„¸ìš”.`
        );
      }
    }
    
    // =============================================
    // í•„í„°
    // =============================================
    function createFilters(regions, genres) {
      const regionEl = document.getElementById('regionFilters');
      const genreEl = document.getElementById('genreFilters');
      
      regionEl.innerHTML = '<button class="filter-btn active" data-region="all">ì „ì²´</button>';
      regions.forEach(r => {
        const btn = document.createElement('button');
        btn.className = 'filter-btn';
        btn.dataset.region = r;
        btn.textContent = r;
        btn.onclick = () => filterByRegion(r);
        regionEl.appendChild(btn);
      });
      
      genreEl.innerHTML = '<button class="filter-btn active" data-genre="all">ì „ì²´</button>';
      genres.forEach(g => {
        const btn = document.createElement('button');
        btn.className = 'filter-btn';
        btn.dataset.genre = g;
        btn.textContent = g;
        btn.onclick = () => filterByGenre(g);
        genreEl.appendChild(btn);
      });
      
      // ì „ì²´ ë²„íŠ¼ ì´ë²¤íŠ¸
      document.querySelector('[data-region="all"]').onclick = () => filterByRegion('all');
      document.querySelector('[data-genre="all"]').onclick = () => filterByGenre('all');
    }
    
    function filterByRegion(region) {
      currentFilters.region = region;
      document.querySelectorAll('[data-region]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.region === region);
      });
      renderList();
      updateMarkers();
    }
    
    function filterByGenre(genre) {
      currentFilters.genre = genre;
      document.querySelectorAll('[data-genre]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.genre === genre);
      });
      renderList();
      updateMarkers();
    }
    
    function getFiltered() {
      return workshopsData.filter(ws => {
        if (currentFilters.region !== 'all' && ws.region !== currentFilters.region) return false;
        if (currentFilters.genre !== 'all' && !ws.genres.includes(currentFilters.genre)) return false;
        return true;
      });
    }
    
    // =============================================
    // ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
    // =============================================
    function renderList() {
      const filtered = getFiltered();
      const container = document.getElementById('workshopList');
      
      container.innerHTML = filtered.map(ws => {
        const genresText = ws.genres.map(g => {
          const icons = { 'ì••í™”': 'ğŸŒ¸', 'ë ˆì§„': 'ğŸ’', 'í•˜ë°”ë¦¬ì›€': 'ğŸŒ¿', 'ë¶€ì¼€ê¸°í”„íŠ¸': 'ğŸ’' };
          return `${icons[g] || 'ğŸ¨'} ${g}`;
        }).join(' | ');
        
        return `
          <div class="workshop-card" data-id="${ws.id}" onclick="selectWorkshop(${ws.id})">
            <span class="badge">â­ ê³µì‹ íŒŒíŠ¸ë„ˆ</span>
            <div class="name">${ws.name}</div>
            <div class="genres">${genresText}</div>
            <div class="address">ğŸ“ ${ws.address}</div>
            <div class="contact">
              <div class="contact-btn" onclick="event.stopPropagation(); window.open('https://instagram.com/${ws.instagram}', '_blank')">ğŸ“· ì¸ìŠ¤íƒ€</div>
              <div class="contact-btn" onclick="event.stopPropagation(); window.location.href='tel:${ws.phone}'">ğŸ“ ì „í™”</div>
            </div>
          </div>
        `;
      }).join('');
      
      document.getElementById('count').textContent = filtered.length;
    }
    
    function selectWorkshop(id) {
      const ws = workshopsData.find(w => w.id === id);
      if (!ws || !naverMap) return;
      
      document.querySelectorAll('.workshop-card').forEach(el => el.classList.remove('active'));
      document.querySelector(`[data-id="${id}"]`)?.classList.add('active');
      
      if (ws.lat && ws.lng) {
        const pos = new naver.maps.LatLng(ws.lat, ws.lng);
        naverMap.setCenter(pos);
        naverMap.setZoom(14);
        
        const marker = markers.find(m => m.id === id);
        if (marker) {
          naver.maps.Event.trigger(marker.marker, 'click');
        }
      }
    }
    
    // =============================================
    // ì§€ë„
    // =============================================
    function waitForNaverAPI(callback, maxAttempts = 50) {
      let attempts = 0;
      const checkInterval = setInterval(() => {
        attempts++;
        
        if (window.naverMapLoadError) {
          clearInterval(checkInterval);
          document.getElementById('mapLoading').innerHTML = 'âŒ<br>ë„¤ì´ë²„ ì§€ë„ API ë¡œë“œ ì‹¤íŒ¨<br><small>ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”</small>';
          showStatus('error', 'âŒ ë„¤ì´ë²„ ì§€ë„ API ë¡œë“œ ì‹¤íŒ¨', 'ë„¤ì´ë²„ í´ë¼ìš°ë“œ ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.<br>localhost:8080ì´ ë“±ë¡ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.');
          return;
        }
        
        if (typeof naver !== 'undefined' && naver.maps) {
          clearInterval(checkInterval);
          log('ë„¤ì´ë²„ ì§€ë„ API ë¡œë“œ í™•ì¸ë¨');
          callback();
          return;
        }
        
        if (attempts >= maxAttempts) {
          clearInterval(checkInterval);
          document.getElementById('mapLoading').innerHTML = 'âŒ<br>ë„¤ì´ë²„ ì§€ë„ API ë¡œë“œ íƒ€ì„ì•„ì›ƒ<br><small>ë„¤ì´ë²„ í´ë¼ìš°ë“œ ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”</small>';
          showStatus('error', 'âŒ ë„¤ì´ë²„ ì§€ë„ API ë¡œë“œ íƒ€ì„ì•„ì›ƒ', 
            'ë„¤ì´ë²„ í´ë¼ìš°ë“œ í”Œë«í¼ì—ì„œ ë‹¤ìŒì„ í™•ì¸í•˜ì„¸ìš”:<br>' +
            '1. Client IDê°€ ì˜¬ë°”ë¥¸ê°€ìš”? (bfp8odep5r)<br>' +
            '2. Web ì„œë¹„ìŠ¤ URLì— http://localhost:8080ì´ ë“±ë¡ë˜ì–´ ìˆë‚˜ìš”?<br>' +
            '3. ì„¤ì • ì €ì¥ í›„ 1-2ë¶„ ê¸°ë‹¤ë ¸ë‚˜ìš”?'
          );
        }
      }, 200); // 200msë§ˆë‹¤ í™•ì¸
    }
    
    function initMap() {
      waitForNaverAPI(() => {
        try {
          if (typeof naver === 'undefined' || !naver.maps) {
            throw new Error('ë„¤ì´ë²„ ì§€ë„ API ë¡œë“œ ì‹¤íŒ¨');
          }
          
          naverMap = new naver.maps.Map('map', {
            center: new naver.maps.LatLng(37.5665, 126.9780),
            zoom: 11
          });
          
          // ì§€ë„ ì´ˆê¸°í™” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
          naver.maps.Event.addListener(naverMap, 'init', () => {
            document.getElementById('mapLoading').style.display = 'none';
            log('ì§€ë„ ì´ˆê¸°í™” ì™„ë£Œ');
            
            if (workshopsData.length > 0) {
              createMarkers();
            }
          });
          
          // íƒ€ì¼ ë¡œë“œ ì—ëŸ¬ ê°ì§€
          naver.maps.Event.addListener(naverMap, 'error', (error) => {
            log('ì§€ë„ ì—ëŸ¬:', error);
            document.getElementById('mapLoading').innerHTML = 'âŒ<br>ì§€ë„ ì¸ì¦ ì‹¤íŒ¨<br><small>ë„¤ì´ë²„ í´ë¼ìš°ë“œ ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”</small>';
            showStatus('error', 'âŒ ë„¤ì´ë²„ ì§€ë„ ì¸ì¦ ì‹¤íŒ¨', 
              'ë„¤ì´ë²„ í´ë¼ìš°ë“œ í”Œë«í¼ì—ì„œ ë‹¤ìŒì„ í™•ì¸í•˜ì„¸ìš”:<br>' +
              '1. Client ID: bfp8odep5r<br>' +
              '2. Web ì„œë¹„ìŠ¤ URL: http://localhost:8080 ë“±ë¡ í™•ì¸<br>' +
              '3. ì„¤ì • ì €ì¥ í›„ ë¸Œë¼ìš°ì € ìƒˆë¡œê³ ì¹¨'
            );
          });
          
        } catch (err) {
          log('ì§€ë„ ì´ˆê¸°í™” ì‹¤íŒ¨:', err);
          document.getElementById('mapLoading').innerHTML = 'âŒ<br>ì§€ë„ ì´ˆê¸°í™” ì‹¤íŒ¨<br><small>' + err.message + '</small>';
          showStatus('error', 'âŒ ì§€ë„ ì´ˆê¸°í™” ì‹¤íŒ¨', err.message);
        }
      });
    }
    
    function createMarkers() {
      if (!naverMap || typeof naver === 'undefined' || !naver.maps) {
        log('ì§€ë„ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•„ ë§ˆì»¤ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        return;
      }
      
      markers.forEach(m => {
        if (m.marker) {
          m.marker.setMap(null);
        }
      });
      markers = [];
      
      workshopsData.forEach(ws => {
        if (!ws.lat || !ws.lng) return;
        
        try {
          const marker = new naver.maps.Marker({
            position: new naver.maps.LatLng(ws.lat, ws.lng),
            map: naverMap,
            title: ws.name
          });
        
        const infoWindow = new naver.maps.InfoWindow({
          content: `
            <div style="padding: 16px; min-width: 200px;">
              <strong>${ws.name}</strong><br>
              <small>${ws.genres.join(', ')}</small><br>
              <small>ğŸ“ ${ws.address}</small>
            </div>
          `
        });
        
        naver.maps.Event.addListener(marker, 'click', () => {
          markers.forEach(m => m.infoWindow.close());
          infoWindow.open(naverMap, marker);
        });
        
          markers.push({ id: ws.id, marker, infoWindow });
        } catch (err) {
          log('ë§ˆì»¤ ìƒì„± ì‹¤íŒ¨:', ws.name, err);
        }
      });
      
      updateMarkers();
    }
    
    function updateMarkers() {
      if (!naverMap || typeof naver === 'undefined' || !naver.maps) {
        return;
      }
      
      const filtered = getFiltered();
      const ids = filtered.map(w => w.id);
      
      markers.forEach(m => {
        if (m.marker) {
          m.marker.setMap(ids.includes(m.id) ? naverMap : null);
        }
      });
      
      if (filtered.length > 0 && markers.length > 0) {
        try {
          const bounds = new naver.maps.LatLngBounds();
          filtered.forEach(ws => {
            if (ws.lat && ws.lng) {
              bounds.extend(new naver.maps.LatLng(ws.lat, ws.lng));
            }
          });
          naverMap.fitBounds(bounds);
        } catch (err) {
          log('ì§€ë„ ë²”ìœ„ ì„¤ì • ì‹¤íŒ¨:', err);
        }
      }
    }
    
    // =============================================
    // ì´ˆê¸°í™”
    // =============================================
    window.addEventListener('DOMContentLoaded', () => {
      log('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
      initMap();
      loadData();
    });
  </script>
  
</body>
</html>
